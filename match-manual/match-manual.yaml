schemaVersion: 3
meta:
  sourceVersionId: 91969c98-811c-4210-aac3-6c36bdf7224f # DO NOT CHANGE - Hex uses this to match up project versions when reimporting the file
  description: null
  projectId: fc81fcd3-0961-4ff8-a485-a95c42f2c645 # DO NOT CHANGE - Unique ID of the project from which this file was generated
  title: "[PROV SERV] Match manual"
  timezone: null
  appTheme: SYS_PREF
  codeLanguage: PYTHON
  status: null
  categories: []
  castDecimalsDefault: true
  logicQueryCacheTimeout: null
  publishedQueryCacheTimeout: null
  hexType: PROJECT
projectAssets:
  dataConnections: []
  envVars: []
  secrets: []
sharedAssets:
  secrets: []
  vcsPackages: []
  dataConnections:
    - dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030 # prod-mapa-org (postgres)
    - dataConnectionId: e088838c-2205-4ff2-870b-07d163c93079 # prod-bonde (postgres)
  externalFileIntegrations: []
cells:
  - cellType: MARKDOWN
    cellId: d5c62d75-05a4-4441-b892-ff2129966a31 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Ol√°! ‚úã  "
    config:
      source: |-
        Ol√°! ‚úã  
        Seja bem-vinda ao app do **match manual**!  
          
        Aqui, voc√™ pode:
        - Buscar volunt√°rias mais pr√≥ximas de uma MSR;
        - Buscar volunt√°rias em um munic√≠pio;
        - Fazer um match entre uma MSR e uma volunt√°ria escolhida.
        </br>
        </br>

        -----------------------------------------------------------------------------
  - cellType: MARKDOWN
    cellId: fde35f07-d246-4d53-8a77-29cbc8ae4b75 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Buscar volunt√°rias mais pr√≥ximas de uma MSR üìå
    config:
      source: |
        ### Buscar volunt√°rias mais pr√≥ximas de uma MSR üìå
        Para buscar as volunt√°rias mais pr√≥ximas de uma MSR, siga esses passos:
        1. **Busque o ID do ticket do Zendesk da MSR**  
              
            Esse ID pode ser encontrado na URL do Ticket. Por exemplo, no caso do ticket https://mapadoacolhimento.zendesk.com/agent/tickets/17470 , o ID √© 17470.  
              
            Esse ID tamb√©m pode ser encontrado no t√≠tulo do ticket conforme mostra a imagem a seguir: 
                
            <img src="/api/v1/file/a9149647-187a-426e-af42-60b5174f9624" width="250" />

        2. **Insira esse ID no campo a seguir e clique em "Bucar volunt√°rias"**  
            
            Iremos buscar as volunt√°rias dispon√≠veis mais pr√≥ximas dessa MSR com o mesmo tipo de acolhimento do ticket que voc√™ inseriu no passo anterior. 
        </br>

        -----------------------------------------------------------------------------
  - cellType: INPUT
    cellId: f6cca30d-338c-4678-99a1-5e44ad15be08 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Ticket ID da MSR no Zendesk
    config:
      inputType: NUMERIC_INPUT
      name: msr_zendesk_ticket_id_fetch_volunteers
      outputType: NUMBER
      options: null
      defaultValue: 80433
  - cellType: INPUT
    cellId: f1e87ce5-cbae-4b04-83e1-4829d084d1f8 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Clique aqui para buscar volunt√°rias
    config:
      inputType: BUTTON
      name: fetch_volunteers_msr
      outputType: BOOLEAN
      options:
        intent: primary
        icon: play
        text: Buscar volunt√°rias
      defaultValue: null
  - cellType: BLOCK
    cellId: f579b2a6-8408-47ad-a512-b408c252cb3b # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      blockConfig:
        sqlCellId: a1835704-f2dd-4b20-801c-e715982b8e9f
        chartCellId: ad92ed2b-859f-4a75-94b7-8ef848347db9
        activeTab: preview
      cells:
        - cellType: SQL
          cellId: a1835704-f2dd-4b20-801c-e715982b8e9f
          cellLabel: "SQL: Busca o tipo de suporte relacionado ao ticket"
          config:
            source: |-
              select * from match.support_requests
              where zendesk_ticket_id = {{ msr_zendesk_ticket_id_fetch_volunteers }}
              limit 1
            dataFrameCell: false
            dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
            resultVariableName: msr_data
            useRichDisplay: false
            sqlCellOutputType: PANDAS
            useQueryMode: false
            castDecimals: true
            useNativeDates: true
            outputFilteredResult: true
            allowDuplicateColumns: false
            tableDisplayConfig:
              pageSize: 50
              height: null
              hideIcons: false
              hideIndex: false
              defaultSortColumn: null
              defaultSortIndexColumn: null
              defaultSortDirection: ASC
              conditionalFormatting: null
              calcs: null
              filters: null
              columnProperties:
                - originalName: accepts_online_support
                  renameTo: null
                  size: 183
                  wrapText: null
                  displayFormat: null
                - originalName: has_disability
                  renameTo: null
                  size: 128
                  wrapText: null
                  displayFormat: null
                - originalName: msr_id
                  renameTo: null
                  size: 126
                  wrapText: null
                  displayFormat: null
                - originalName: priority
                  renameTo: null
                  size: 94
                  wrapText: null
                  displayFormat: null
                - originalName: requires_libras
                  renameTo: null
                  size: 136
                  wrapText: null
                  displayFormat: null
                - originalName: support_expertise
                  renameTo: null
                  size: 153
                  wrapText: null
                  displayFormat: null
                - originalName: support_request_id
                  renameTo: null
                  size: 162
                  wrapText: null
                  displayFormat: null
                - originalName: support_type
                  renameTo: null
                  size: 127
                  wrapText: null
                  displayFormat: null
                - originalName: zendesk_ticket_id
                  renameTo: null
                  size: 153
                  wrapText: null
                  displayFormat: null
              columnOrdering: null
              pinnedColumns: null
              hiddenColumns: null
              pinIndexColumns: false
        - cellType: CHARTV2
          cellId: ad92ed2b-859f-4a75-94b7-8ef848347db9
          cellLabel: "SQL: Busca o tipo de suporte relacionado ao ticket"
          config:
            height: null
            chartSpec:
              type: layered
              layers:
                - id: 36127662-fd70-436e-9954-b3e6dd9fc7b4
                  xAxis:
                    type: string
                    style:
                      grid:
                        style: solid
                      ticks: {}
                      labels: {}
                    dataFrameColumn: support_type
                  series:
                    - id: 801e4d73-1868-4e00-8d0a-3caa7cf58287
                      type: bar
                      axis:
                        type: number
                        style:
                          grid:
                            style: solid
                          ticks: {}
                          labels: {}
                        aggregate: sum
                      dataFrameColumns:
                        - priority
                      colorOrder: ascending
                      color:
                        type: static
                      opacity:
                        type: static
                        value: 1
                      tooltip:
                        type: auto
                      barWidth: 1
                      orientation: vertical
                      layout: grouped
                  dataFrame: msr_data
              settings:
                legend:
                  position: right
                tooltip: true
                selectionEnabled: false
            chartSelection: {}
            colorMappings: {}
            resultVariable: filter_result
            outputResult: false
            displayTableConfig: null
  - cellType: SQL
    cellId: 02837760-8ce2-4987-8ca4-7675685d149c # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Volunt√°rias dispon√≠veis com mesmo support_type"
    config:
      source: |-
        WITH msr_support_type AS (
            SELECT support_type 
            FROM match.support_requests
            WHERE 
                zendesk_ticket_id = {{ msr_zendesk_ticket_id_fetch_volunteers }}
            LIMIT 1
        ),
        completed_matches_by_volunteer AS (
            SELECT
                volunteer_id, 
                COUNT(*) AS completed_matches
            FROM match.matches
            WHERE status = 'completed'
            GROUP BY 1
        )
        SELECT 
            volunteer_id,
            email,
            first_name,
            last_name,
            a.support_expertise,
            years_of_experience,
            phone,
            a.offers_libras_support,
            a.city,
            a.state,
            lat,
            lng,
            current_matches,
            max_matches,
            COALESCE(completed_matches, 0) AS completed_matches
        FROM public.volunteer_availability a
        INNER JOIN msr_support_type b ON a.support_type::VARCHAR = b.support_type::VARCHAR
        LEFT JOIN volunteers c ON c.id = a.volunteer_id
        LEFT JOIN completed_matches_by_volunteer USING (volunteer_id)
        WHERE is_available = TRUE AND lat IS NOT null and lng IS NOT null
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: available_volunteers
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: first_name
            renameTo: null
            size: 113
            wrapText: null
            displayFormat: null
          - originalName: lat
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: lng
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: volunteer_id
            renameTo: null
            size: 122
            wrapText: null
            displayFormat: null
        columnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
  - cellType: CODE
    cellId: 3d9e4835-dbcd-4a01-b586-9803e548d3d7 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: Calcula dist√¢ncias das Volunt√°rias √† MSR"
    config:
      source: |
        from geopy.distance import geodesic

        # Calculate the distance between two points
        def calculate_distance(lat1, lng1, lat2, lng2):
            return geodesic((lat1, lng1), (lat2, lng2)).kilometers


        # Get the reference point from the first row of msr_data
        ref_point = msr_data.iloc[0][["lat", "lng"]]

        available_volunteers_with_distance = available_volunteers.copy()

        # Calculate the distance for each volunteer and add it as a new column
        if (fetch_volunteers_msr == True):
            available_volunteers_with_distance["distance_to_msr"] = available_volunteers.apply(
                lambda row: calculate_distance(
                    row["lat"], row["lng"], ref_point["lat"], ref_point["lng"]
                ),
                axis=1,
            )
  - cellType: BLOCK
    cellId: e18fd256-84db-4136-bd94-908d0e5dbf6a # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      blockConfig:
        sqlCellId: 85771ba1-1922-4f3b-aafd-a2c8f94d5822
        chartCellId: c8860d1d-513b-4739-8756-44201aa33bd2
        activeTab: display
      cells:
        - cellType: SQL
          cellId: 85771ba1-1922-4f3b-aafd-a2c8f94d5822
          cellLabel: "SQL: Mostra a tabela com as volunt√°rias mais pr√≥ximas √† MSR"
          config:
            source: |-
              SELECT
                  CONCAT(ROUND(distance_to_msr, 1)::VARCHAR, ' km') AS "dist√¢ncia √† MSR",
                  CONCAT(first_name, ' ', last_name) AS "nome",
                  email AS "e-mail",
                  CASE
                      WHEN phone = 'not_found' THEN '-'
                      ELSE phone 
                  END AS "telefone",
                  CASE 
                      WHEN support_expertise = 'not_found' THEN '-'
                      ELSE support_expertise
                  END AS "especialidades",
                  CASE 
                      WHEN years_of_experience = 'not_found' THEN '-'
                      ELSE years_of_experience
                  END AS "anos de experi√™ncia",
                  max_matches::VARCHAR AS "disponibilidade",
                  current_matches AS "matches em curso",
                  completed_matches AS "matches conclu√≠dos",
                  city AS munic√≠pio,
                  state AS UF
              FROM available_volunteers_with_distance
              ORDER BY distance_to_msr
            dataFrameCell: true
            dataConnectionId: null
            resultVariableName: closest_volunteers
            useRichDisplay: true
            sqlCellOutputType: PANDAS
            useQueryMode: false
            castDecimals: true
            useNativeDates: true
            outputFilteredResult: true
            allowDuplicateColumns: false
            tableDisplayConfig:
              pageSize: 15
              height: 421
              hideIcons: true
              hideIndex: true
              defaultSortColumn: null
              defaultSortIndexColumn: null
              defaultSortDirection: ASC
              conditionalFormatting: null
              calcs: null
              filters: null
              columnProperties:
                - originalName: UF
                  renameTo: null
                  size: 70
                  wrapText: null
                  displayFormat: null
                - originalName: anos de experi√™ncia
                  renameTo: null
                  size: 143
                  wrapText: null
                  displayFormat: null
                - originalName: cidade
                  renameTo: null
                  size: 132
                  wrapText: null
                  displayFormat: null
                - originalName: city
                  renameTo: null
                  size: 132
                  wrapText: null
                  displayFormat: null
                - originalName: disp m√°x para matches
                  renameTo: null
                  size: 161
                  wrapText: null
                  displayFormat: null
                - originalName: disp. para matches
                  renameTo: null
                  size: 134
                  wrapText: null
                  displayFormat: null
                - originalName: disponibilidade
                  renameTo: null
                  size: 115
                  wrapText: null
                  displayFormat: null
                - originalName: disponibilidade matches
                  renameTo: null
                  size: 170
                  wrapText: null
                  displayFormat: null
                - originalName: distance_to_msr
                  renameTo: null
                  size: 157
                  wrapText: null
                  displayFormat: null
                - originalName: distancia
                  renameTo: null
                  size: 169
                  wrapText: null
                  displayFormat: null
                - originalName: dist√¢ncia √† MSR
                  renameTo: null
                  size: 121
                  wrapText: null
                  displayFormat: null
                - originalName: dist√¢ncia √† MSR (km)
                  renameTo: null
                  size: 148
                  wrapText: null
                  displayFormat: null
                - originalName: e-mail
                  renameTo: null
                  size: 209
                  wrapText: null
                  displayFormat: null
                - originalName: email
                  renameTo: null
                  size: 227
                  wrapText: null
                  displayFormat: null
                - originalName: especialidades
                  renameTo: null
                  size: 116
                  wrapText: null
                  displayFormat: null
                - originalName: first_name
                  renameTo: null
                  size: 113
                  wrapText: null
                  displayFormat: null
                - originalName: j√° possui matches
                  renameTo: null
                  size: 136
                  wrapText: null
                  displayFormat: null
                - originalName: last_name
                  renameTo: null
                  size: 167
                  wrapText: null
                  displayFormat: null
                - originalName: lat
                  renameTo: null
                  size: 162
                  wrapText: null
                  displayFormat: null
                - originalName: lng
                  renameTo: null
                  size: 162
                  wrapText: null
                  displayFormat: null
                - originalName: matches atuais
                  renameTo: null
                  size: 122
                  wrapText: null
                  displayFormat: null
                - originalName: matches conclu√≠dos
                  renameTo: null
                  size: 143
                  wrapText: null
                  displayFormat: null
                - originalName: matches em curso
                  renameTo: null
                  size: 135
                  wrapText: null
                  displayFormat: null
                - originalName: max_matches
                  renameTo: null
                  size: 112
                  wrapText: null
                  displayFormat: null
                - originalName: munic√≠pio
                  renameTo: null
                  size: 149
                  wrapText: null
                  displayFormat: null
                - originalName: m√°x. matches
                  renameTo: null
                  size: 98
                  wrapText: null
                  displayFormat: null
                - originalName: nome
                  renameTo: null
                  size: 230
                  wrapText: null
                  displayFormat: null
                - originalName: nome da Volunt√°ria
                  renameTo: null
                  size: 200
                  wrapText: null
                  displayFormat: null
                - originalName: offers_libras_support
                  renameTo: null
                  size: 152
                  wrapText: null
                  displayFormat: null
                - originalName: phone
                  renameTo: null
                  size: 126
                  wrapText: null
                  displayFormat: null
                - originalName: quantos matches tem atualmente
                  renameTo: null
                  size: 134
                  wrapText: null
                  displayFormat: null
                - originalName: state
                  renameTo: null
                  size: 82
                  wrapText: null
                  displayFormat: null
                - originalName: support_expertise
                  renameTo: null
                  size: 134
                  wrapText: null
                  displayFormat: null
                - originalName: telefone
                  renameTo: null
                  size: 126
                  wrapText: null
                  displayFormat: null
                - originalName: total de matches
                  renameTo: null
                  size: 114
                  wrapText: null
                  displayFormat: null
                - originalName: volunteer_id
                  renameTo: null
                  size: 122
                  wrapText: null
                  displayFormat: null
              columnOrdering: null
              pinnedColumns: null
              hiddenColumns: null
              pinIndexColumns: false
        - cellType: CHARTV2
          cellId: c8860d1d-513b-4739-8756-44201aa33bd2
          cellLabel: "SQL: Mostra a tabela com as volunt√°rias mais pr√≥ximas √† MSR"
          config:
            height: null
            chartSpec:
              type: layered
              layers:
                - id: 2d9f3e1b-8770-44c7-9a34-c8ce6c3ae26f
                  xAxis:
                    type: string
                    style:
                      grid:
                        style: solid
                      ticks: {}
                      labels: {}
                  series:
                    - id: c7cba894-4693-4760-822f-341dbb650acc
                      type: bar
                      axis:
                        type: number
                        style:
                          grid:
                            style: solid
                          ticks: {}
                          labels: {}
                      dataFrameColumns: []
                      colorOrder: ascending
                      color:
                        type: static
                      opacity:
                        type: static
                        value: 1
                      tooltip:
                        type: auto
                      barWidth: 1
                      orientation: vertical
                      layout: grouped
                  dataFrame: closest_volunteers
              settings:
                legend:
                  position: right
                tooltip: true
                selectionEnabled: false
            chartSelection: {}
            colorMappings: {}
            resultVariable: filter_result
            outputResult: false
            displayTableConfig: null
  - cellType: MARKDOWN
    cellId: 46213b09-37e5-476c-9841-d9620c7f44ae # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Buscar volunt√°rias em um munic√≠pio üåé
    config:
      source: |-
        -----------------------------------------------------------------------------

        ### Buscar volunt√°rias em um munic√≠pio üåé
        Para buscar as volunt√°rias em um munc√≠pio, siga esses passos:
        1. **Selecione a UF no campo abaixo**  

        2. **Selecione o munic√≠pio**  

        3. **Selecione o tipo de acolhimento**
  - cellType: SQL
    cellId: 58b72927-22b4-4aa8-9b15-82a4463b4e51 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Busca UFs"
    config:
      source: |-
        SELECT 
            DISTINCT state
        FROM cities
        ORDER BY state
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: states
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: state
            renameTo: null
            size: 82
            wrapText: null
            displayFormat: null
        columnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
  - cellType: INPUT
    cellId: b66cb92a-dadc-4de8-a589-67969461614e # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: UF
    config:
      inputType: DROPDOWN
      name: state
      outputType: DYNAMIC
      options:
        valueOptions:
          dfName: states
          columnName: state
          variableName: states['state']
      defaultValue: PE
  - cellType: SQL
    cellId: 9e6e7b1a-8cc1-47ff-aa2a-ce099ea2b0d2 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Busca munic√≠pios"
    config:
      source: |-
        SELECT city_value
        FROM cities
        WHERE state = COALESCE({{ state }}, 'AC')
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: cities
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: INPUT
    cellId: 3e5893a2-ee4d-49e2-ae7c-d6770a2e2a48 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Munic√≠pio
    config:
      inputType: DROPDOWN
      name: city
      outputType: DYNAMIC
      options:
        valueOptions:
          dfName: cities
          columnName: city_value
          variableName: cities['city_value']
      defaultValue: RECIFE
  - cellType: INPUT
    cellId: 34d67caa-9f4a-4b0e-9632-567e87c2e085 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Tipo de acolhimento
    config:
      inputType: DROPDOWN
      name: support_type
      outputType: STRING
      options:
        valueOptions:
          - Psicol√≥gico
          - Jur√≠dico
      defaultValue: Jur√≠dico
  - cellType: SQL
    cellId: a2977f05-156f-42c2-b045-2ec5fabc467c # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Mostra as Volunt√°rias no munic√≠pio selecionado"
    config:
      source: |-
        SELECT
            CONCAT(first_name, ' ', last_name) AS "nome",
            email AS "e-mail",
            CASE
                WHEN phone = 'not_found' THEN '-'
                ELSE phone 
            END AS "telefone",
            CASE 
                WHEN a.support_expertise = 'not_found' THEN '-'
                ELSE a.support_expertise
            END AS "especialidades",
            CASE 
                WHEN years_of_experience = 'not_found' THEN '-'
                ELSE years_of_experience
            END AS "anos de experi√™ncia",
            max_matches::VARCHAR AS "disponibilidade",
            current_matches AS "j√° possui matches",
            a.city AS munic√≠pio,
            a.state AS UF
        FROM volunteer_availability a
        LEFT JOIN volunteers b ON id = volunteer_id
        WHERE 
            is_available = TRUE
            AND support_type = CASE WHEN {{ support_type }} = 'Psicol√≥gico' THEN 'psychological' ELSE 'legal' END
            AND a.city = {{ city }}
            AND a.state = {{ state }}
        LIMIT 100
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: volunteer_city
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 15
        height: 421
        hideIcons: true
        hideIndex: true
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: anos de experi√™ncia
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: disponibilidade
            renameTo: null
            size: 137
            wrapText: null
            displayFormat: null
          - originalName: e-mail
            renameTo: null
            size: 211
            wrapText: null
            displayFormat: null
          - originalName: especialidades
            renameTo: null
            size: 135
            wrapText: null
            displayFormat: null
          - originalName: j√° possui matches
            renameTo: null
            size: 151
            wrapText: null
            displayFormat: null
          - originalName: munic√≠pio
            renameTo: null
            size: 108
            wrapText: null
            displayFormat: null
          - originalName: nome
            renameTo: null
            size: 180
            wrapText: null
            displayFormat: null
          - originalName: telefone
            renameTo: null
            size: 131
            wrapText: null
            displayFormat: null
          - originalName: uf
            renameTo: null
            size: 66
            wrapText: null
            displayFormat: null
        columnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
  - cellType: MARKDOWN
    cellId: 3a6d4371-2cf9-47f2-ae11-c379afc10cf1 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Buscar MSRs pr√≥ximas de uma Volunt√°ria
    config:
      source: |
        ### Buscar MSRs mais pr√≥ximas de uma volunt√°ria üìç
        Para buscar as MSRs mais pr√≥ximas de uma volunt√°ria, siga esses passos:
        1. **Insira o e-mail da volunt√°ria no campo abaixo**  

        2. **Clique em "Bucar MSRs"**  


        -----------------------------------------------------------------------------
  - cellType: INPUT
    cellId: 09048cba-1de5-4811-b103-58aee5a2d47e # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: E-mail da volunt√°ira
    config:
      inputType: TEXT_INPUT
      name: search_msr_volunteer_email
      outputType: STRING
      options: null
      defaultValue: dev.psi.mapa@gmail.com
  - cellType: INPUT
    cellId: 55effd50-bc3f-46da-ac45-9531f33a28b1 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Clique aqui para buscar MSRs
    config:
      inputType: BUTTON
      name: fetch_msrs
      outputType: BOOLEAN
      options:
        intent: none
        icon: play
        text: Buscar MSRs
      defaultValue: null
  - cellType: SQL
    cellId: f7f03074-5ae5-4a33-8791-02a6d0a183ff # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Busca support_requests com o mesmo support_type"
    config:
      source: |-
        WITH fetch_volunteer_support_type AS (
            SELECT support_type 
            FROM volunteers
            LEFT JOIN volunteer_availability ON id = volunteer_id
            WHERE 
                email = {{ search_msr_volunteer_email }}
            LIMIT 1
        )
        SELECT 
            msr_id,
            zendesk_ticket_id,
            status,
            city,
            state,
            lat,
            lng
        FROM match.support_requests s
        INNER JOIN fetch_volunteer_support_type v ON v.support_type = s.support_type::VARCHAR
        WHERE 
            status IN ('open', 'public_service')
            AND lat IS NOT NULL
            AND lng IS NOT NULL
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: msrs_waiting_for_match
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: SQL
    cellId: 554d4831-35f1-42ee-bdea-5fc087267e77 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Busca infos das MSRs na solidarity_users"
    config:
      source: |-
        SELECT 
            user_id AS msr_id,
            name AS nome,
            email, 
            whatsapp AS phone
        FROM solidarity_users
        WHERE organization_id = 360273031591
      dataFrameCell: false
      dataConnectionId: e088838c-2205-4ff2-870b-07d163c93079
      resultVariableName: msr_info
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: CODE
    cellId: 3119dfe8-6722-407f-b961-12a286c0da90 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: Calcula dist√¢ncias das MSRs √† Volunt√°ria"
    config:
      source: |
        from geopy.distance import geodesic

        # Calculate the distance between two points
        def calculate_distance(lat1, lng1, lat2, lng2):
            return geodesic((lat1, lng1), (lat2, lng2)).kilometers


        # Get the reference point from the first row of msr_data
        ref_point = msr_data.iloc[0][["lat", "lng"]]

        msrs_with_distance = msrs_waiting_for_match.copy()

        # Calculate the distance for each volunteer and add it as a new column
        if (fetch_msrs == True):
            msrs_with_distance["distance_to_volunteer"] = msrs_waiting_for_match.apply(
                lambda row: calculate_distance(
                    row["lat"], row["lng"], ref_point["lat"], ref_point["lng"]
                ),
                axis=1,
            )
  - cellType: SQL
    cellId: 294bbb1c-3227-4d71-a337-514e13cf5b09 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Mostra a tabela com as MSRs mais pr√≥ximas √† Volunt√°ria"
    config:
      source: |-
        SELECT
            CONCAT(ROUND(distance_to_volunteer, 1)::VARCHAR, ' km') AS "dist√¢ncia √† Volunt√°ria",
            nome,
            email AS "e-mail",
            zendesk_ticket_id AS "ticket ID",
            CASE
                WHEN phone IS NULL THEN '-'
                ELSE phone 
            END AS "telefone",
            CASE
                WHEN status = 'open' THEN 'solicita√ß√£o recebida'
                ELSE 'encaminhada para servi√ßo p√∫blico'
            END AS status,
            city AS munic√≠pio,
            state AS UF
        FROM msrs_with_distance
        INNER JOIN msr_info USING (msr_id)
        ORDER BY distance_to_volunteer 
      dataFrameCell: true
      dataConnectionId: null
      resultVariableName: dataframe
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 15
        height: 420
        hideIcons: true
        hideIndex: true
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: UF
            renameTo: null
            size: 70
            wrapText: null
            displayFormat: null
          - originalName: dist√¢ncia √† Volunt√°ria
            renameTo: null
            size: 171
            wrapText: null
            displayFormat: null
          - originalName: e-mail
            renameTo: null
            size: 244
            wrapText: null
            displayFormat: null
          - originalName: munic√≠pio
            renameTo: null
            size: 108
            wrapText: null
            displayFormat: null
          - originalName: nome
            renameTo: null
            size: 168
            wrapText: null
            displayFormat: null
          - originalName: status
            renameTo: null
            size: 216
            wrapText: null
            displayFormat: null
          - originalName: telefone
            renameTo: null
            size: 111
            wrapText: null
            displayFormat: null
          - originalName: ticket ID
            renameTo: null
            size: 101
            wrapText: null
            displayFormat: null
        columnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
  - cellType: MARKDOWN
    cellId: 27cbec60-f605-48c5-85e4-95ca57c6c7d6 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Fazer um match entre uma MSR e uma volunt√°ria escolhida ü§ù
    config:
      source: |
        ---------------------------------------------------------

        ### Fazer um match entre uma MSR e uma volunt√°ria escolhida ü§ù
        Se voc√™ j√° escolheu a volunt√°ria para realizar o match, siga esses passos:
        1. **Insira o ID do ticket da MSR no campo a seguir**  
              
            Se voc√™ n√£o souber como buscar esse ID, d√™ uma olhada no texto l√° em cima. 
        2. **Insira o e-mail da volunt√°ria no campo a seguir**
        3. **Clique em "Fazer match"**
  - cellType: INPUT
    cellId: 6f9be99b-4f4c-4c67-bebc-ffea253b74e9 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Ticket ID da MSR no Zendesk
    config:
      inputType: NUMERIC_INPUT
      name: msr_zendesk_ticket_id_match
      outputType: NUMBER
      options: null
      defaultValue: 80125
  - cellType: INPUT
    cellId: cd6a439f-ab51-4aad-814d-17848de07376 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: E-mail da volunt√°ria
    config:
      inputType: TEXT_INPUT
      name: volunteer_email
      outputType: STRING
      options: null
      defaultValue: voluntaria@teste.com
  - cellType: INPUT
    cellId: 697f3285-7c20-47cf-9e39-5fb4cbd71700 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Clique aqui para fazer o match
    config:
      inputType: BUTTON
      name: run_match
      outputType: BOOLEAN
      options:
        intent: primary
        icon: play
        text: Fazer match
      defaultValue: null
  - cellType: CODE
    cellId: b3622178-fbbd-4c82-89de-bf4a91f48c31 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: manda um request para a Lambda do Novo Match"
    config:
      source: |-
        import requests
        import json

        # Define the function to make the request
        def make_request():
            # Define the endpoint
            endpoint = "https://6y5g1a25q4.execute-api.sa-east-1.amazonaws.com/manual-match"

            # Define the parameters
            body = {
                "volunteerEmail": volunteer_email,
                "msrZendeskTicketId": msr_zendesk_ticket_id_match,
            }

            headers = {"Content-type": "application/json"}

            # Make the request
            response = requests.post(endpoint, json=body, headers=headers)
            if response.status_code == requests.codes.ok:
                print("Match realizado com sucesso <3")
            else:
                print("Por algum motivo o match n√£o deu certo :/ Manda esse erro pra equipe de tech:", response.json())


        if run_match == True:
            make_request()
        else:
            print("Aguardando comando para realizar o match...")
appLayout:
  visibleMetadataFields:
    - NAME
    - DESCRIPTION
    - AUTHOR
    - LAST_EDITED
    - LAST_RUN
    - CATEGORIES
    - STATUS
    - TABLE_OF_CONTENTS
  fullWidth: false
  tabs:
    - name: Tab 1
      rows:
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: d5c62d75-05a4-4441-b892-ff2129966a31
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: fde35f07-d246-4d53-8a77-29cbc8ae4b75
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 25
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: f6cca30d-338c-4678-99a1-5e44ad15be08
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 25
              end: 55
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: f1e87ce5-cbae-4b04-83e1-4829d084d1f8
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 85771ba1-1922-4f3b-aafd-a2c8f94d5822
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 46213b09-37e5-476c-9841-d9620c7f44ae
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 30
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: b66cb92a-dadc-4de8-a589-67969461614e
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 30
              end: 60
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 3e5893a2-ee4d-49e2-ae7c-d6770a2e2a48
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 60
              end: 90
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 34d67caa-9f4a-4b0e-9632-567e87c2e085
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: a2977f05-156f-42c2-b045-2ec5fabc467c
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 3a6d4371-2cf9-47f2-ae11-c379afc10cf1
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 30
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 09048cba-1de5-4811-b103-58aee5a2d47e
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 30
              end: 60
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 55effd50-bc3f-46da-ac45-9531f33a28b1
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 294bbb1c-3227-4d71-a337-514e13cf5b09
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 27cbec60-f605-48c5-85e4-95ca57c6c7d6
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 30
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 6f9be99b-4f4c-4c67-bebc-ffea253b74e9
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 30
              end: 60
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: cd6a439f-ab51-4aad-814d-17848de07376
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 60
              end: 90
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 697f3285-7c20-47cf-9e39-5fb4cbd71700
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: b3622178-fbbd-4c82-89de-bf4a91f48c31
                  sharedFilterId: null
                  height: null
                  showLabel: false
sharedFilters: []
