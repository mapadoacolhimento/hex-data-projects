schemaVersion: 3
meta:
  sourceVersionId: 04b47322-6932-4ee6-8fb3-1acdcd0e4c1c # DO NOT CHANGE - Hex uses this to match up project versions when reimporting the file
  description: null
  projectId: 9ac76a7d-92d7-44c5-8b37-f959af2fb5de # DO NOT CHANGE - Unique ID of the project from which this file was generated
  title: "[PROV SERV] Servi√ßos P√∫blicos"
  timezone: Brazil/East
  appTheme: SYS_PREF
  codeLanguage: PYTHON
  status: null
  categories: []
  castDecimalsDefault: true
  logicQueryCacheTimeout:
    type: disabled
  publishedQueryCacheTimeout:
    type: disabled
  hexType: PROJECT
  allowExecutionReordering: true
  prerunApp: false
  cachePublishedAppState: false
  refreshStalePublishedApp: false
  autoRerunApp: false
projectAssets:
  dataConnections: []
  envVars: []
  secrets: []
sharedAssets:
  secrets: []
  vcsPackages: []
  dataConnections:
    - dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030 # prod-mapa-org (postgres)
    - dataConnectionId: e088838c-2205-4ff2-870b-07d163c93079 # prod-bonde (postgres)
  externalFileIntegrations: []
cells:
  - cellType: MARKDOWN
    cellId: 0048354c-3ee9-46f9-89ed-45bbfb0c0189 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Ol√°! ‚úã  "
    config:
      source: |-
        Ol√°! ‚úã  
        Seja bem-vinda ao app de **Servi√ßos P√∫blicos**!  
          
        Aqui, voc√™ pode:
        - Buscar Servi√ßos P√∫blicos mais pr√≥ximos de uma MSR, filtrando por tipo;
        - Buscar Servi√ßos P√∫blicos em um munic√≠pio, filtrando por tipo;
        - Fazer um encaminhamento qualificado de uma MSR para os Servi√ßos P√∫blicos escolhidos.
        </br>
        </br>

        -----------------------------------------------------------------------------
  - cellType: MARKDOWN
    cellId: 07aacd15-27a2-45e3-8ef9-afa8bedd5568 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Buscar volunt√°rias mais pr√≥ximas de uma MSR üìå
    config:
      source: |-
        ------
        ### Buscar Servi√ßos P√∫blicos mais pr√≥ximos de uma MSR üìå
        Para buscar as volunt√°rias mais pr√≥ximas de uma MSR, siga esses passos:
        1. **Busque o ID do ticket do Zendesk da MSR**  
              
            Esse ID pode ser encontrado na URL do Ticket. Por exemplo, no caso do ticket https://mapadoacolhimento.zendesk.com/agent/tickets/17470 , o ID √© 17470.  
              
            Esse ID tamb√©m pode ser encontrado no t√≠tulo do ticket conforme mostra a imagem a seguir: 
                
            <img src="/api/v1/file/bd0cb080-a3ba-4405-85c0-0f2b2df794fb" width="250" />

        2. **Insira esse ID no campo a seguir;**

        3. **Filtre os tipos de Servi√ßo P√∫blico, se necess√°rio;**

         4. **Clique em "Buscar Servi√ßos P√∫blicos"**  
         
        </br>
  - cellType: SQL
    cellId: 75a37164-ad76-4c97-b31d-2f67dc3706e4 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Distinct service type
    config:
      source: |-
        SELECT DISTINCT service_type
        FROM public_services.public_services
        ORDER BY service_type
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: distinct_service_type
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: address
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: city
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: email
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: lat
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: lng
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: phone
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: public_service_id
            renameTo: null
            size: 204
            wrapText: null
            displayFormat: null
          - originalName: region
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 46
            wrapText: null
            displayFormat: null
          - originalName: service_name
            renameTo: null
            size: 144
            wrapText: null
            displayFormat: null
          - originalName: service_type
            renameTo: null
            size: 834
            wrapText: null
            displayFormat: null
          - originalName: state
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: zipcode
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: INPUT
    cellId: cd31b454-170f-4dc7-b688-3ecd8d62938b # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Ticket ID da MSR no Zendesk
    config:
      inputType: NUMERIC_INPUT
      name: msr_zendesk_ticket_id_fetch_public_service
      outputType: NUMBER
      options: null
      defaultValue: 8653
  - cellType: INPUT
    cellId: 71132133-3f9f-4014-ab17-260c13cfbe58 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Tipo de Servi√ßo P√∫blico
    config:
      inputType: MULTISELECT
      name: service_type_msr
      outputType: LIST_STRING
      options:
        multiValueOptions:
          dfName: distinct_service_type
          columnName: service_type
          variableName: distinct_service_type['service_type']
      defaultValue:
        - __hex_multiselect_select_all_option__
  - cellType: INPUT
    cellId: 58bc7ee1-6efe-4231-9f4f-a25216c72de8 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Clique aqui para buscar Servi√ßo P√∫blicos
    config:
      inputType: BUTTON
      name: fetch_volunteers_msr
      outputType: BOOLEAN
      options:
        intent: success
        icon: play
        text: Buscar Servi√ßos P√∫blicos
      defaultValue: null
  - cellType: BLOCK
    cellId: 5ed8664a-f7b6-4996-89bf-60ff3a23da00 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      blockConfig:
        sqlCellId: 7532744f-2576-4851-b1dd-e82b6d13a0b3
        chartCellId: 3dac292b-89f5-4b3a-a433-966576154900
        activeTab: preview
      cells:
        - cellType: SQL
          cellId: 7532744f-2576-4851-b1dd-e82b6d13a0b3
          cellLabel: "SQL: Busca o tipo de suporte relacionado ao ticket"
          config:
            source: |-
              select * from match.support_requests
              where zendesk_ticket_id = {{ msr_zendesk_ticket_id_fetch_public_service }}
              limit 1
            dataFrameCell: false
            dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
            resultVariableName: msr_data
            useRichDisplay: false
            sqlCellOutputType: PANDAS
            useQueryMode: false
            castDecimals: true
            useNativeDates: true
            outputFilteredResult: true
            allowDuplicateColumns: false
            tableDisplayConfig:
              pageSize: 50
              height: null
              hideIcons: false
              hideIndex: false
              defaultSortColumn: null
              defaultSortIndexColumn: null
              defaultSortDirection: ASC
              conditionalFormatting: null
              calcs: null
              filters: null
              columnProperties:
                - originalName: accepts_online_support
                  renameTo: null
                  size: 183
                  wrapText: null
                  displayFormat: null
                - originalName: has_disability
                  renameTo: null
                  size: 128
                  wrapText: null
                  displayFormat: null
                - originalName: msr_id
                  renameTo: null
                  size: 126
                  wrapText: null
                  displayFormat: null
                - originalName: priority
                  renameTo: null
                  size: 94
                  wrapText: null
                  displayFormat: null
                - originalName: requires_libras
                  renameTo: null
                  size: 136
                  wrapText: null
                  displayFormat: null
                - originalName: support_expertise
                  renameTo: null
                  size: 153
                  wrapText: null
                  displayFormat: null
                - originalName: support_request_id
                  renameTo: null
                  size: 162
                  wrapText: null
                  displayFormat: null
                - originalName: support_type
                  renameTo: null
                  size: 127
                  wrapText: null
                  displayFormat: null
                - originalName: zendesk_ticket_id
                  renameTo: null
                  size: 153
                  wrapText: null
                  displayFormat: null
              columnOrdering: null
              customColumnOrdering: null
              pinnedColumns: null
              hiddenColumns: null
              pinIndexColumns: false
              showAggregations: false
              columnAggregations: null
        - cellType: CHARTV2
          cellId: 3dac292b-89f5-4b3a-a433-966576154900
          cellLabel: "SQL: Busca o tipo de suporte relacionado ao ticket"
          config:
            height: null
            chartSpec:
              type: layered
              layers:
                - id: 36127662-fd70-436e-9954-b3e6dd9fc7b4
                  xAxis:
                    type: string
                    style:
                      grid:
                        style: solid
                      ticks: {}
                      labels: {}
                    dataFrameColumn: support_type
                  series:
                    - id: 801e4d73-1868-4e00-8d0a-3caa7cf58287
                      type: bar
                      axis:
                        type: number
                        style:
                          grid:
                            style: solid
                          ticks: {}
                          labels: {}
                        aggregate: sum
                      dataFrameColumns:
                        - priority
                      colorOrder: ascending
                      color:
                        type: static
                      opacity:
                        type: static
                        value: 1
                      tooltip:
                        type: auto
                      barWidth: 1
                      orientation: vertical
                      layout: grouped
                  dataFrame: msr_data
              settings:
                legend:
                  position: right
                tooltip: true
                selectionEnabled: false
            chartSelection: {}
            colorMappings: {}
            resultVariable: filter_result
            outputResult: false
            displayType: CHART
            displayTableConfig: null
  - cellType: SQL
    cellId: d3e68c89-c25e-4214-9e05-b24d9b875cf0 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Servi√ßos P√∫blicos com o mesmo service_type e lat lng not null"
    config:
      source: |-
        SELECT *
        FROM public_services.public_services
        WHERE 
            service_type::VARCHAR IN ({{ service_type_msr | array }})
            AND lat IS NOT NULL
            AND lng IS NOT NULL
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: public_services
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: first_name
            renameTo: null
            size: 113
            wrapText: null
            displayFormat: null
          - originalName: lat
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: lng
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: volunteer_id
            renameTo: null
            size: 122
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: f17ddf35-d6d7-4c5d-8897-494e54fbdf6a # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: Calcula dist√¢ncias dos Servi√ßos P√∫blicos √† MSR"
    config:
      source: |
        from geopy.distance import geodesic

        # Calculate the distance between two points
        def calculate_distance(lat1, lng1, lat2, lng2):
            return geodesic((lat1, lng1), (lat2, lng2)).kilometers


        # Get the reference point from the first row of msr_data
        ref_point = msr_data.iloc[0][["lat", "lng"]]

        public_services_with_distance = public_services.copy()

        # Calculate the distance for each volunteer and add it as a new column
        if (fetch_volunteers_msr == True):
            public_services_with_distance["distance_to_msr"] = public_services.apply(
                lambda row: calculate_distance(
                    row["lat"], row["lng"], ref_point["lat"], ref_point["lng"]
                ),
                axis=1,
            )
  - cellType: BLOCK
    cellId: 613a5225-aeab-41f1-901e-459f096313a4 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      blockConfig:
        sqlCellId: 78cbbb81-152d-40cc-9add-64ad46b0a60a
        chartCellId: b62c213b-35c7-429d-bc3b-3309229b3c08
        activeTab: display
      cells:
        - cellType: SQL
          cellId: 78cbbb81-152d-40cc-9add-64ad46b0a60a
          cellLabel: "SQL: Mostra a tabela com as volunt√°rias mais pr√≥ximas √† MSR"
          config:
            source: |-
              {% if fetch_volunteers_msr %}
              SELECT
                  CONCAT(ROUND(distance_to_msr, 1)::VARCHAR, ' km') AS "dist√¢ncia √† MSR",
                  public_service_id AS id,
                  service_type AS "tipo de servi√ßo",
                  service_name AS "nome do servi√ßo",
                  phone AS telefone,
                  email,
                  zipcode AS cep,
                  address AS "endere√ßo",
                  city AS cidade,
                  state AS uf
              FROM public_services_with_distance
              ORDER BY distance_to_msr

              {% else %}
              SELECT
                  0 AS "dist√¢ncia √† MSR",
                  public_service_id AS id,
                  service_type AS "tipo de servi√ßo",
                  service_name AS "nome do servi√ßo",
                  phone AS telefone,
                  email,
                  zipcode AS cep,
                  address AS "endere√ßo",
                  city AS cidade,
                  state AS uf
              FROM public_services_with_distance
              WHERE 0 = 1

              {% endif %}
            dataFrameCell: true
            dataConnectionId: null
            resultVariableName: closest_public_services
            useRichDisplay: true
            sqlCellOutputType: PANDAS
            useQueryMode: false
            castDecimals: true
            useNativeDates: true
            outputFilteredResult: true
            allowDuplicateColumns: false
            tableDisplayConfig:
              pageSize: 15
              height: 421
              hideIcons: true
              hideIndex: true
              defaultSortColumn: null
              defaultSortIndexColumn: null
              defaultSortDirection: ASC
              conditionalFormatting: null
              calcs: null
              filters: null
              columnProperties:
                - originalName: UF
                  renameTo: null
                  size: 70
                  wrapText: null
                  displayFormat: null
                - originalName: address
                  renameTo: null
                  size: 400
                  wrapText: null
                  displayFormat: null
                - originalName: anos de experi√™ncia
                  renameTo: null
                  size: 143
                  wrapText: null
                  displayFormat: null
                - originalName: cep
                  renameTo: null
                  size: 94
                  wrapText: null
                  displayFormat: null
                - originalName: cidade
                  renameTo: null
                  size: 132
                  wrapText: null
                  displayFormat: null
                - originalName: city
                  renameTo: null
                  size: 132
                  wrapText: null
                  displayFormat: null
                - originalName: disp m√°x para matches
                  renameTo: null
                  size: 161
                  wrapText: null
                  displayFormat: null
                - originalName: disp. para matches
                  renameTo: null
                  size: 134
                  wrapText: null
                  displayFormat: null
                - originalName: disponibilidade
                  renameTo: null
                  size: 115
                  wrapText: null
                  displayFormat: null
                - originalName: disponibilidade matches
                  renameTo: null
                  size: 170
                  wrapText: null
                  displayFormat: null
                - originalName: distance_to_msr
                  renameTo: null
                  size: 157
                  wrapText: null
                  displayFormat: null
                - originalName: distancia
                  renameTo: null
                  size: 169
                  wrapText: null
                  displayFormat: null
                - originalName: dist√¢ncia √† MSR
                  renameTo: null
                  size: 121
                  wrapText: null
                  displayFormat: null
                - originalName: dist√¢ncia √† MSR (km)
                  renameTo: null
                  size: 148
                  wrapText: null
                  displayFormat: null
                - originalName: e-mail
                  renameTo: null
                  size: 209
                  wrapText: null
                  displayFormat: null
                - originalName: email
                  renameTo: null
                  size: 227
                  wrapText: null
                  displayFormat: null
                - originalName: endere√ßo
                  renameTo: null
                  size: 400
                  wrapText: null
                  displayFormat: null
                - originalName: especialidades
                  renameTo: null
                  size: 116
                  wrapText: null
                  displayFormat: null
                - originalName: first_name
                  renameTo: null
                  size: 113
                  wrapText: null
                  displayFormat: null
                - originalName: id
                  renameTo: null
                  size: 61
                  wrapText: null
                  displayFormat: null
                - originalName: id do servi√ßo p√∫blico
                  renameTo: null
                  size: 140
                  wrapText: null
                  displayFormat: null
                - originalName: j√° possui matches
                  renameTo: null
                  size: 136
                  wrapText: null
                  displayFormat: null
                - originalName: last_name
                  renameTo: null
                  size: 167
                  wrapText: null
                  displayFormat: null
                - originalName: lat
                  renameTo: null
                  size: 162
                  wrapText: null
                  displayFormat: null
                - originalName: lng
                  renameTo: null
                  size: 162
                  wrapText: null
                  displayFormat: null
                - originalName: matches atuais
                  renameTo: null
                  size: 122
                  wrapText: null
                  displayFormat: null
                - originalName: matches conclu√≠dos
                  renameTo: null
                  size: 143
                  wrapText: null
                  displayFormat: null
                - originalName: matches em curso
                  renameTo: null
                  size: 135
                  wrapText: null
                  displayFormat: null
                - originalName: max_matches
                  renameTo: null
                  size: 112
                  wrapText: null
                  displayFormat: null
                - originalName: munic√≠pio
                  renameTo: null
                  size: 149
                  wrapText: null
                  displayFormat: null
                - originalName: m√°x. matches
                  renameTo: null
                  size: 98
                  wrapText: null
                  displayFormat: null
                - originalName: nome
                  renameTo: null
                  size: 230
                  wrapText: null
                  displayFormat: null
                - originalName: nome da Volunt√°ria
                  renameTo: null
                  size: 200
                  wrapText: null
                  displayFormat: null
                - originalName: nome do servi√ßo
                  renameTo: null
                  size: 400
                  wrapText: null
                  displayFormat: null
                - originalName: offers_libras_support
                  renameTo: null
                  size: 152
                  wrapText: null
                  displayFormat: null
                - originalName: phone
                  renameTo: null
                  size: 126
                  wrapText: null
                  displayFormat: null
                - originalName: public_service_id
                  renameTo: null
                  size: 127
                  wrapText: null
                  displayFormat: null
                - originalName: quantos matches tem atualmente
                  renameTo: null
                  size: 134
                  wrapText: null
                  displayFormat: null
                - originalName: region
                  renameTo: null
                  size: 92
                  wrapText: null
                  displayFormat: null
                - originalName: service_name
                  renameTo: null
                  size: 400
                  wrapText: null
                  displayFormat: null
                - originalName: state
                  renameTo: null
                  size: 82
                  wrapText: null
                  displayFormat: null
                - originalName: support_expertise
                  renameTo: null
                  size: 134
                  wrapText: null
                  displayFormat: null
                - originalName: telefone
                  renameTo: null
                  size: 126
                  wrapText: null
                  displayFormat: null
                - originalName: tipo de servi√ßo
                  renameTo: null
                  size: 225
                  wrapText: null
                  displayFormat: null
                - originalName: total de matches
                  renameTo: null
                  size: 114
                  wrapText: null
                  displayFormat: null
                - originalName: uf
                  renameTo: null
                  size: 50
                  wrapText: null
                  displayFormat: null
                - originalName: volunteer_id
                  renameTo: null
                  size: 122
                  wrapText: null
                  displayFormat: null
                - originalName: zipcode
                  renameTo: null
                  size: 94
                  wrapText: null
                  displayFormat: null
              columnOrdering: null
              customColumnOrdering: null
              pinnedColumns: null
              hiddenColumns: null
              pinIndexColumns: false
              showAggregations: false
              columnAggregations: null
        - cellType: CHARTV2
          cellId: b62c213b-35c7-429d-bc3b-3309229b3c08
          cellLabel: "SQL: Mostra a tabela com as volunt√°rias mais pr√≥ximas √† MSR"
          config:
            height: null
            chartSpec:
              type: layered
              layers:
                - id: 2d9f3e1b-8770-44c7-9a34-c8ce6c3ae26f
                  xAxis:
                    type: string
                    style:
                      grid:
                        style: solid
                      ticks: {}
                      labels: {}
                  series:
                    - id: c7cba894-4693-4760-822f-341dbb650acc
                      type: bar
                      axis:
                        type: number
                        style:
                          grid:
                            style: solid
                          ticks: {}
                          labels: {}
                      dataFrameColumns: []
                      colorOrder: ascending
                      color:
                        type: static
                      opacity:
                        type: static
                        value: 1
                      tooltip:
                        type: auto
                      barWidth: 1
                      orientation: vertical
                      layout: grouped
                  dataFrame: closest_public_services
              settings:
                legend:
                  position: right
                tooltip: true
                selectionEnabled: false
            chartSelection: {}
            colorMappings: {}
            resultVariable: filter_result
            outputResult: false
            displayType: CHART
            displayTableConfig: null
  - cellType: MARKDOWN
    cellId: a83a4c9e-feb0-4e0b-92a1-df4790e7403b # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Buscar volunt√°rias em um munic√≠pio üåé
    config:
      source: |-
        -----------------------------------------------------------------------------

        ### Buscar Servi√ßos P√∫blicos em um munic√≠pio üåé
        Para buscar as Servi√ßos P√∫blicos em um munc√≠pio, siga esses passos:
        1. **Selecione a UF no campo abaixo**  

        2. **Selecione o munic√≠pio**  

        3. **Selecione o tipo de Servi√ßo P√∫blico**
  - cellType: SQL
    cellId: 9e6d0eaf-7928-469e-8f41-d9e28e11ff0b # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Busca UFs"
    config:
      source: |-
        SELECT 
            DISTINCT state
        FROM cities
        ORDER BY state
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: states
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: row-index-0
            renameTo: null
            size: 46
            wrapText: null
            displayFormat: null
          - originalName: state
            renameTo: null
            size: 82
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: INPUT
    cellId: 82b93920-a97f-4186-b8f5-1aca36039a1e # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: UF
    config:
      inputType: DROPDOWN
      name: state
      outputType: DYNAMIC
      options:
        valueOptions:
          dfName: states
          columnName: state
          variableName: states['state']
      defaultValue: AC
  - cellType: INPUT
    cellId: b9ac8bd9-ed8b-4841-8706-51e08c56262d # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Clique aqui para buscar os munic√≠pios
    config:
      inputType: BUTTON
      name: buscar_munic√≠pios_dessa_uf
      outputType: BOOLEAN
      options:
        intent: success
        icon: play
        text: Buscar munic√≠pios
      defaultValue: null
  - cellType: SQL
    cellId: c421e1c9-2381-42cc-b4fd-b5b9e6106d95 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Busca munic√≠pios"
    config:
      source: |-
        
        {% if buscar_munic√≠pios_dessa_uf %}
        SELECT city_value
        FROM cities
        WHERE state = {{ state }}
        ORDER BY 1

        {% else %}
        SELECT city_value
        FROM cities
        WHERE state = 'AC'
        ORDER BY 1

        {% endif %}
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: cities
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: INPUT
    cellId: f0319217-be26-4c29-9a18-28b52491bd2f # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Munic√≠pio
    config:
      inputType: DROPDOWN
      name: city
      outputType: DYNAMIC
      options:
        valueOptions:
          dfName: cities
          columnName: city_value
          variableName: cities['city_value']
      defaultValue: RIO BRANCO
  - cellType: INPUT
    cellId: 8543946c-0469-4ba1-972f-e541d7ee1934 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Tipo de servi√ßo p√∫blico
    config:
      inputType: MULTISELECT
      name: service_type_city
      outputType: DYNAMIC
      options:
        multiValueOptions:
          dfName: distinct_service_type
          columnName: service_type
          variableName: distinct_service_type['service_type']
      defaultValue:
        - __hex_multiselect_select_all_option__
  - cellType: INPUT
    cellId: 1905418d-6150-421c-a0a5-0dc770745b29 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Clique aqui para buscar Servi√ßos P√∫blicos
    config:
      inputType: BUTTON
      name: bucar_voluntarias_municipio
      outputType: BOOLEAN
      options:
        intent: success
        icon: play
        text: Buscar Servi√ßos P√∫blicos
      defaultValue: null
  - cellType: SQL
    cellId: 96414a14-ecb7-4ec5-a2f2-bbc84e57bed9 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Mostra as Servi√ßos P√∫blicos no munic√≠pio selecionado"
    config:
      source: |-
        {% if bucar_voluntarias_municipio %}
        SELECT
            public_service_id AS id,
            service_type AS "tipo de servi√ßo",
            service_name AS "nome do servi√ßo",
            phone AS telefone,
            email,
            zipcode AS cep,
            address AS "endere√ßo",
            city AS cidade,
            state AS uf
        FROM public_services.public_services 
        WHERE 
            service_type::VARCHAR IN ({{ service_type_city | array }})
            AND city = {{ city }}
            AND state = {{ state }}
        LIMIT 100

        {% else %}
        SELECT
            public_service_id AS id,
            service_type AS "tipo de servi√ßo",
            service_name AS "nome do servi√ßo",
            phone AS telefone,
            email,
            zipcode AS cep,
            address AS "endere√ßo",
            city AS cidade,
            state AS uf
        FROM public_services.public_services 
        WHERE 
            0 = 1

        {% endif %}
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: volunteer_city
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 15
        height: 421
        hideIcons: true
        hideIndex: true
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: address
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: anos de experi√™ncia
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: cep
            renameTo: null
            size: 94
            wrapText: null
            displayFormat: null
          - originalName: cidade
            renameTo: null
            size: 128
            wrapText: null
            displayFormat: null
          - originalName: city
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: created_at
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: disponibilidade
            renameTo: null
            size: 137
            wrapText: null
            displayFormat: null
          - originalName: e-mail
            renameTo: null
            size: 211
            wrapText: null
            displayFormat: null
          - originalName: email
            renameTo: null
            size: 228
            wrapText: null
            displayFormat: null
          - originalName: endere√ßo
            renameTo: null
            size: 400
            wrapText: null
            displayFormat: null
          - originalName: especialidades
            renameTo: null
            size: 135
            wrapText: null
            displayFormat: null
          - originalName: id
            renameTo: null
            size: 50
            wrapText: null
            displayFormat: null
          - originalName: j√° possui matches
            renameTo: null
            size: 151
            wrapText: null
            displayFormat: null
          - originalName: lat
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: lng
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: munic√≠pio
            renameTo: null
            size: 108
            wrapText: null
            displayFormat: null
          - originalName: nome
            renameTo: null
            size: 180
            wrapText: null
            displayFormat: null
          - originalName: nome do servi√ßo
            renameTo: null
            size: 291
            wrapText: null
            displayFormat: null
          - originalName: phone
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: public_service_id
            renameTo: null
            size: 204
            wrapText: null
            displayFormat: null
          - originalName: region
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: service_name
            renameTo: null
            size: 144
            wrapText: null
            displayFormat: null
          - originalName: service_type
            renameTo: null
            size: 144
            wrapText: null
            displayFormat: null
          - originalName: state
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: telefone
            renameTo: null
            size: 131
            wrapText: null
            displayFormat: null
          - originalName: tipo de servi√ßo
            renameTo: null
            size: 334
            wrapText: null
            displayFormat: null
          - originalName: uf
            renameTo: null
            size: 66
            wrapText: null
            displayFormat: null
          - originalName: updated_at
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: zipcode
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: MARKDOWN
    cellId: 94b25a72-b777-43e4-a46f-19fd600a535c # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Fazer um encaminhamento qualificado para um Servi√ßo P√∫blico üè†Ô∏è
    config:
      source: |
        ---------------------------------------------------------

        ### Fazer um encaminhamento qualificado para um Servi√ßo P√∫blico üè†Ô∏è
        Se voc√™ j√° escolheu os Servi√ßos P√∫blicos para realizar o encaminhamento, siga esses passos:
        1. **Insira o ID do ticket da MSR no campo a seguir**  
              
            Se voc√™ n√£o souber como buscar esse ID, d√™ uma olhada no texto l√° em cima. 
        2. **Insira o e-mail da volunt√°ria no campo a seguir**
        3. **Clique em "Fazer match"**
  - cellType: SQL
    cellId: c0c82837-74b7-43b0-bfef-dc2b6c29760c # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: all public services
    config:
      source: |-
        SELECT 
            *
        FROM public_services.public_services
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: all_public_services
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: INPUT
    cellId: 7f729eac-2ac2-43a1-8468-c5248c9af5ff # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Ticket ID da MSR no Zendesk
    config:
      inputType: NUMERIC_INPUT
      name: msr_zendesk_ticket_id_match
      outputType: NUMBER
      options: null
      defaultValue: 17470
  - cellType: INPUT
    cellId: ae462774-41b1-40e4-89ec-bca974bd38fa # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Servi√ßos P√∫blicos escolhidos
    config:
      inputType: MULTISELECT
      name: chosen_public_services
      outputType: DYNAMIC
      options:
        multiValueOptions:
          dfName: all_public_services
          columnName: public_service_id
          variableName: all_public_services['public_service_id']
      defaultValue:
        - 1
        - 2
        - 29
  - cellType: INPUT
    cellId: bd7df384-d712-4679-84d7-96f15c47e123 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Clique aqui para gerar a mensagem de encaminhamento
    config:
      inputType: BUTTON
      name: generate_text
      outputType: BOOLEAN
      options:
        intent: success
        icon: play
        text: Fazer encaminhamento
      defaultValue: null
  - cellType: SQL
    cellId: 11982d5f-f9ab-43c4-8e56-5b75e3907ab9 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Dataframe 2
    config:
      source: |
        {% if generate_text %}

        SELECT msr_id
        FROM match.support_requests
        WHERE zendesk_ticket_id = {{ msr_zendesk_ticket_id_match }}

        {% else %}

        SELECT msr_id
        FROM match.support_requests
        WHERE 0 = 1

        {% endif %}
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: support_requests
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: SQL
    cellId: 4e60229c-dfb4-41de-bccd-61d3f7dc35ac # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Msrs
    config:
      source: |-
        {% if generate_text %}

        SELECT 
            msr_id,
            first_name AS msr_first_name
        FROM pii_sec.msr_pii

        {% else %}

        SELECT 
            msr_id,
            first_name AS msr_first_name
        FROM pii_sec.msr_pii
        WHERE 0 = 1

        {% endif %}
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: msrs
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: SQL
    cellId: 3c05c5bb-e45e-499b-9ef3-83b778aed6da # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Chosen msr
    config:
      source: |-
        {% if generate_text %}

        SELECT msr_first_name
        FROM msrs
        INNER JOIN support_requests USING(msr_id)
        LIMIT 1

        {% else %}

        SELECT msr_first_name
        FROM msrs
        INNER JOIN support_requests USING(msr_id)
        WHERE 0 = 1
        LIMIT 1

        {% endif %}
      dataFrameCell: true
      dataConnectionId: null
      resultVariableName: chosen_msr
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: CODE
    cellId: 8c799423-e14c-4b21-a709-354cfc3e16b0 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: gera text"
    config:
      source: |
        from IPython.display import display_markdown

        filtered_public_services = all_public_services[all_public_services['public_service_id'].isin(chosen_public_services)]

        msr_first_name = chosen_msr['msr_first_name'][0]

        intro = (
            f'---- \n'
            f'Ol√°, {msr_first_name}! \n \n'
            f'Conforme informamos em seu atendimento social com a assistente social de nossa equipe, **precisaremos encaminh√°-la para o(s) servi√ßo(s) p√∫blico(s) de sua regi√£o**, para que sua demanda seja acolhida integralmente e de forma qualificada, bem como, para que voc√™ possa ser amparada por uma equipe multidisciplinar (composta por profissionais de diferentes categorias) especializada! \n \n'
            f'Atrav√©s do atendimento realizado, compreendemos que voc√™ precisa acessar o(s) seguinte(s) servi√ßo(s) da Rede P√∫blica de Enfrentamento √† Viol√™ncia Contra a Mulher: \n'
        )

        public_services_string = ""

        for index, row in filtered_public_services.iterrows():
            service_name = row['service_name'] if (row['service_name'] != 'not_found' and row['service_name'] != 'N/I') else row['service_type']
            address = row['address'].title() if row['address'] != 'not_found' else '-'
            phone = row['phone'] if row['phone'] != 'not_found' else '-'


            public_services_string += (
                f'- **{service_name}** \n'
                f'   - Endere√ßo: {address} \n'
                f'   - Telefone: {phone} \n'
                f'   - Hor√°rio de atendimento: - \n' 
                f'   - Orienta√ß√µes: - \n' 
            )

        end = '''
        \n
        Em anexo, segue a Carta de Encaminhamento, que √© um documento que voc√™ pode imprimir ou somente apresentar no momento da chegada no servi√ßo p√∫blico. Nele constar√£o informa√ß√µes a respeito da sua demanda, que ajudar√£o na efetividade do seu atendimento. \n
        Qualquer dificuldade ou d√∫vida sobre este encaminhamento, n√£o hesite em nos retornar, respondendo este e-mail ou escrevendo para atendimento@mapadoacolhimento.org. \n
        Esperamos que consiga encontrar a ajuda que tanto precisa neste momento! \n
        Um abra√ßo afetuoso, \n
        Equipe do Mapa do Acolhimento <3

        '''

        if generate_text:
            display_markdown(intro + public_services_string + end, raw=True)
        else:
            print("Aguardando comando para gerar o encaminhamento...")
appLayout:
  visibleMetadataFields:
    - NAME
    - DESCRIPTION
    - AUTHOR
    - LAST_EDITED
    - LAST_RUN
    - CATEGORIES
    - STATUS
    - TABLE_OF_CONTENTS
  fullWidth: false
  tabs:
    - name: Tab 1
      rows:
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 07aacd15-27a2-45e3-8ef9-afa8bedd5568
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 25
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: cd31b454-170f-4dc7-b688-3ecd8d62938b
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 25
              end: 55
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 71132133-3f9f-4014-ab17-260c13cfbe58
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 55
              end: 85
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 58bc7ee1-6efe-4231-9f4f-a25216c72de8
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 78cbbb81-152d-40cc-9add-64ad46b0a60a
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: a83a4c9e-feb0-4e0b-92a1-df4790e7403b
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 10
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 82b93920-a97f-4186-b8f5-1aca36039a1e
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 10
              end: 40
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: b9ac8bd9-ed8b-4841-8706-51e08c56262d
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 30
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: f0319217-be26-4c29-9a18-28b52491bd2f
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 30
              end: 55
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 8543946c-0469-4ba1-972f-e541d7ee1934
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 55
              end: 90
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 1905418d-6150-421c-a0a5-0dc770745b29
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 96414a14-ecb7-4ec5-a2f2-bbc84e57bed9
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 94b25a72-b777-43e4-a46f-19fd600a535c
                  sharedFilterId: null
                  height: null
                  showLabel: false
        - columns:
            - start: 0
              end: 30
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 7f729eac-2ac2-43a1-8468-c5248c9af5ff
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 30
              end: 60
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: ae462774-41b1-40e4-89ec-bca974bd38fa
                  sharedFilterId: null
                  height: null
                  showLabel: true
            - start: 60
              end: 100
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: bd7df384-d712-4679-84d7-96f15c47e123
                  sharedFilterId: null
                  height: null
                  showLabel: true
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: false
                  hideOutput: false
                  type: CELL
                  cellId: 8c799423-e14c-4b21-a709-354cfc3e16b0
                  sharedFilterId: null
                  height: null
                  showLabel: false
sharedFilters: []
