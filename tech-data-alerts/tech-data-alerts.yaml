schemaVersion: 3
meta:
  sourceVersionId: 74905633-e633-4937-a8f4-16307cdfea85 # DO NOT CHANGE - Hex uses this to match up project versions when reimporting the file
  description: Esse notebook contém os alertas de inconsistências no nosso banco de dados
  projectId: 180416ec-9554-406b-bd4d-c4b4a95399be # DO NOT CHANGE - Unique ID of the project from which this file was generated
  title: "[TECH] Data alerts"
  timezone: null
  appTheme: SYS_PREF
  codeLanguage: PYTHON
  status: null
  categories: []
  castDecimalsDefault: true
  logicQueryCacheTimeout: null
  publishedQueryCacheTimeout: null
  hexType: PROJECT
  allowExecutionReordering: true
  prerunApp: false
  cachePublishedAppState: true
  refreshStalePublishedApp: false
  autoRerunApp: true
projectAssets:
  dataConnections: []
  envVars: []
  secrets: []
sharedAssets:
  secrets: []
  vcsPackages: []
  dataConnections:
    - dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030 # prod-mapa-org (postgres)
    - dataConnectionId: e088838c-2205-4ff2-870b-07d163c93079 # prod-bonde (postgres)
  externalFileIntegrations: []
cells:
  - cellType: CODE
    cellId: b049966a-8b29-4a9d-bfcf-8ffd00d285d8 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Erros
    config:
      source: errors = []
  - cellType: MARKDOWN
    cellId: 8524b95f-e7c3-4048-8c71-1269518ebb20 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem voluntárias disponíveis para match com condition != 'disponivel'"
  - cellType: SQL
    cellId: d3cd7862-9773-4728-b8ad-1989178b3553 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Voluntárias que estão disponíveis na tabela volunteer_availability, mas não disponíveis na tabela volunteers"
    config:
      source: |-
        SELECT COUNT(*)
        FROM volunteer_availability
        LEFT JOIN volunteers ON id = volunteer_id
        WHERE condition != 'disponivel' AND is_available = TRUE
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: available_volunteers
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: count
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: current_matches
            renameTo: null
            size: 147
            wrapText: null
            displayFormat: null
          - originalName: is_available
            renameTo: null
            size: 118
            wrapText: null
            displayFormat: null
          - originalName: lat
            renameTo: null
            size: 83
            wrapText: null
            displayFormat: null
          - originalName: lng
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: max_matches
            renameTo: null
            size: 131
            wrapText: null
            displayFormat: null
          - originalName: offers_online_support
            renameTo: null
            size: 173
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 39
            wrapText: null
            displayFormat: null
          - originalName: support_expertise
            renameTo: null
            size: 153
            wrapText: null
            displayFormat: null
          - originalName: support_type
            renameTo: null
            size: 127
            wrapText: null
            displayFormat: null
          - originalName: volunteer_availability.city
            renameTo: null
            size: 191
            wrapText: null
            displayFormat: null
          - originalName: volunteer_id
            renameTo: null
            size: 122
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: e3d90b90-063d-45e6-afe1-03f775e8df56 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: Voluntárias que estão disponíveis na tabela volunteer_availability, mas não disponíveis na tabela volunteers"
    config:
      source: |-
        if(available_volunteers['count'][0] != 0):
            errors.append("Existem voluntárias disponíveis para match com condition != 'disponivel'")
  - cellType: MARKDOWN
    cellId: 89984bf0-2ecb-4c95-929a-2051f763e86a # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem voluntárias condition = 'disponivel' e is_available = FALSE"
  - cellType: SQL
    cellId: 4bf484a5-b1a4-4017-982b-d29f903ed72b # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Voluntárias que estão com status Disponível mas is_available = FALSE"
    config:
      source: |-
        SELECT COUNT(*)
        FROM volunteer_availability
        LEFT JOIN volunteers ON id = volunteer_id
        WHERE condition = 'disponivel' AND is_available = FALSE
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: unavailable_volunteers
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: count
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: current_matches
            renameTo: null
            size: 147
            wrapText: null
            displayFormat: null
          - originalName: is_available
            renameTo: null
            size: 118
            wrapText: null
            displayFormat: null
          - originalName: lat
            renameTo: null
            size: 83
            wrapText: null
            displayFormat: null
          - originalName: lng
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: max_matches
            renameTo: null
            size: 131
            wrapText: null
            displayFormat: null
          - originalName: offers_online_support
            renameTo: null
            size: 173
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 39
            wrapText: null
            displayFormat: null
          - originalName: support_expertise
            renameTo: null
            size: 153
            wrapText: null
            displayFormat: null
          - originalName: support_type
            renameTo: null
            size: 127
            wrapText: null
            displayFormat: null
          - originalName: volunteer_availability.city
            renameTo: null
            size: 191
            wrapText: null
            displayFormat: null
          - originalName: volunteer_id
            renameTo: null
            size: 122
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: 7c119f1f-1463-417a-b0be-8ce754a3758c # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: Voluntárias que estão com status Disponível mas is_available = FALSE"
    config:
      source: |-
        if(unavailable_volunteers['count'][0] != 0):
            errors.append("Existem voluntárias condition = 'disponivel' e is_available = FALSE")
  - cellType: MARKDOWN
    cellId: caf79766-75cd-49f1-a7d6-97f61277a0ff # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem voluntárias com discrepâncias no número de matches"
  - cellType: SQL
    cellId: 2b4cf9bf-0562-4666-9826-4b0516f83cd0 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: voluntárias com current_matches diferente do verificado na tabela matches"
    config:
      source: |-
        WITH match_count AS (
            SELECT
                volunteer_id,
                current_matches,
                COUNT(*) AS calculated_current_matches
            FROM match.matches 
            LEFT JOIN volunteer_availability USING (volunteer_id)
            WHERE 
                volunteer_id IS NOT NULL
                AND status IN ('waiting_contact', 'in_contact')
            GROUP BY volunteer_id, current_matches
        )
        SELECT COUNT(*)
        FROM match_count
        WHERE calculated_current_matches != current_matches
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: volunteers_match_count
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: CODE
    cellId: e9f2705f-e96a-48d7-b956-8e9dd43fa138 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: voluntárias com current_matches diferente do verificado na tabela matches"
    config:
      source: |-
        if(volunteers_match_count['count'][0] != 0):
            errors.append("Existem voluntárias com discrepâncias no número de matches")
  - cellType: MARKDOWN
    cellId: 05dc8248-8cb1-481a-9e23-646483112368 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Voluntárias sem volunteer_availability"
  - cellType: SQL
    cellId: 6a945c3f-4563-470f-ae32-954c61f319dc # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Voluntárias sem volunteer_availability"
    config:
      source: |-
        SELECT COUNT(*)
        FROM volunteers
        LEFT JOIN volunteer_availability ON id = volunteer_id
        WHERE is_available IS NULL
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: no_volunteer_availability
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: count
            renameTo: null
            size: 82
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 39
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: 26edf21e-643a-4d58-9cff-51f607773662 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: voluntárias sem volunteer_availability"
    config:
      source: |-
        if(no_volunteer_availability['count'][0] != 0):
            errors.append("Existem voluntárias que estão na tabela volunteers, mas não estão na tabela volunteer_availability")
  - cellType: MARKDOWN
    cellId: c94f11e1-980f-47d9-bbd5-c345415960df # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Voluntárias indiponíveis receberam match no último dia"
  - cellType: SQL
    cellId: 76bc3fb0-d44a-4f1c-a1ed-4ff3718cbb12 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Voluntárias indisponíveis que receberam match no último dia"
    config:
      source: |-
        SELECT 
            COUNT(*)
        FROM match.matches m
        LEFT JOIN volunteers v ON id = volunteer_id
        WHERE 
            m.created_at > CURRENT_DATE - INTERVAL '1 DAY'
            AND status = 'waiting_contact' 
            AND condition NOT IN ('disponivel', 'indisponivel_sem_vagas')
            AND match_type != 'manual'
            AND m.created_at >= v.updated_at
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: unavailable_volunteer_match_count
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: condition
            renameTo: null
            size: 185
            wrapText: null
            displayFormat: null
          - originalName: count
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: match_id
            renameTo: null
            size: 105
            wrapText: null
            displayFormat: null
          - originalName: match_stage
            renameTo: null
            size: 124
            wrapText: null
            displayFormat: null
          - originalName: match_type
            renameTo: null
            size: 119
            wrapText: null
            displayFormat: null
          - originalName: msr_id
            renameTo: null
            size: 133
            wrapText: null
            displayFormat: null
          - originalName: msr_zendesk_ticket_id
            renameTo: null
            size: 180
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 39
            wrapText: null
            displayFormat: null
          - originalName: support_request_id
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: support_type
            renameTo: null
            size: 127
            wrapText: null
            displayFormat: null
          - originalName: volunteer_id
            renameTo: null
            size: 122
            wrapText: null
            displayFormat: null
          - originalName: volunteer_zendesk_ticket_id
            renameTo: null
            size: 210
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: aac2fbc0-2a06-4979-95c4-62c7fe7d81e7 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: Voluntárias indisponíveis que receberam match no último dia"
    config:
      source: |-
        if(unavailable_volunteer_match_count['count'][0] != 0):
            errors.append("Voluntárias indiponíveis receberam match no último dia")
  - cellType: MARKDOWN
    cellId: e31aab7e-5415-4a62-9057-7eed83d5cc62 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem inconsistências na tabela support_request_status_history"
  - cellType: SQL
    cellId: d4bffaf0-346b-40b2-bf88-300250775e38 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: inconsistências na tabela support_request_status_history"
    config:
      source: |-
        WITH rn_status_history AS (
            SELECT 
                support_request_id,
                status AS status_history,
                ROW_NUMBER() OVER(PARTITION BY support_request_id ORDER BY created_at DESC) AS rn
            FROM match.support_request_status_history
        ),
        most_recent_status_history AS (
            SELECT
                support_request_id,
                status_history
            FROM rn_status_history
            WHERE rn = 1
        )
        SELECT  COUNT(*)
        FROM match.support_requests
        LEFT JOIN most_recent_status_history USING (support_request_id)
        WHERE status != status_history
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: support_request_status_history
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: accepts_online_support
            renameTo: null
            size: 183
            wrapText: null
            displayFormat: null
          - originalName: count
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: has_disability
            renameTo: null
            size: 128
            wrapText: null
            displayFormat: null
          - originalName: msr_id
            renameTo: null
            size: 132
            wrapText: null
            displayFormat: null
          - originalName: priority
            renameTo: null
            size: 94
            wrapText: null
            displayFormat: null
          - originalName: requires_libras
            renameTo: null
            size: 136
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 39
            wrapText: null
            displayFormat: null
          - originalName: status
            renameTo: null
            size: 88
            wrapText: null
            displayFormat: null
          - originalName: status_history
            renameTo: null
            size: 132
            wrapText: null
            displayFormat: null
          - originalName: support_expertise
            renameTo: null
            size: 153
            wrapText: null
            displayFormat: null
          - originalName: support_request_id
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: support_type
            renameTo: null
            size: 127
            wrapText: null
            displayFormat: null
          - originalName: zendesk_ticket_id
            renameTo: null
            size: 153
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: a01e0fdd-fdd9-47f6-a19e-511c88ae9290 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: inconsistências na tabela support_request_status_history"
    config:
      source: |-
        if(support_request_status_history['count'][0] != 0):
            errors.append("Existem inconsistências na tabela support_request_status_history")
  - cellType: MARKDOWN
    cellId: 73d2a62c-ca87-46c5-8205-33bd67bb91b7 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem inconsistências na tabela match_status_history"
  - cellType: SQL
    cellId: 5572a79a-96f6-43ed-98a9-7694baeb7315 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: inconsistências na tabela match_status_history"
    config:
      source: |-
        WITH rn_status_history AS (
            SELECT 
                match_id,
                status AS status_history,
                ROW_NUMBER() OVER(PARTITION BY match_id ORDER BY created_at DESC) AS rn
            FROM match.match_status_history
        ),
        most_recent_status_history AS (
            SELECT
                match_id,
                status_history
            FROM rn_status_history
            WHERE rn = 1
        )
        SELECT  COUNT(*)
        FROM match.matches
        LEFT JOIN most_recent_status_history USING (match_id)
        WHERE status != status_history
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: match_status_history
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: CODE
    cellId: 894d2fa3-3847-4f7e-96ed-a11442a9a16f # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: inconsistências na tabela match_status_history"
    config:
      source: |-
        if(match_status_history['count'][0] != 0):
            errors.append("Existem inconsistências na tabela match_status_history")
  - cellType: MARKDOWN
    cellId: cbc2ceb9-0845-4c84-aa47-d9b65a7b331e # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem inconsistências na tabela volunteer_status_history"
  - cellType: SQL
    cellId: 087bb058-3b94-4b4b-9211-9c8afd1d5ff9 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: inconsistências na tabela volunteer_status_history"
    config:
      source: |-
        WITH rn_status_history AS (
            SELECT 
                volunteer_id,
                status AS status_history,
                ROW_NUMBER() OVER(PARTITION BY volunteer_id ORDER BY created_at DESC) AS rn
            FROM volunteer_status_history
        ),
        most_recent_status_history AS (
            SELECT
                volunteer_id,
                status_history
            FROM rn_status_history
            WHERE rn = 1
        )
        SELECT COUNT(*)
        FROM volunteers
        LEFT JOIN most_recent_status_history ON id = volunteer_id
        WHERE condition != status_history
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: volunteer_status_history
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: CODE
    cellId: b24ec0c6-6f25-4d66-9e0a-7d5d7c8232f4 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: inconsistências na tabela volunteer_status_history"
    config:
      source: |-
        if(volunteer_status_history['count'][0] != 0):
            errors.append("Existem inconsistências na tabela volunteer_status_history")
  - cellType: MARKDOWN
    cellId: cdcac8e4-d5d7-4cf4-8416-f2d04bda022e # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem problemas de integração das MSRs no listener-solidarity"
  - cellType: SQL
    cellId: 77ba3d01-cfc1-44c1-ae0c-528ff51b25cc # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: problema de integração das MSRs no listener-solidarity"
    config:
      source: |-
        SELECT 
            COUNT(*)
        FROM form_entries
        WHERE 
            rede_syncronized = FALSE 
            AND widget_id = 16850
      dataFrameCell: false
      dataConnectionId: e088838c-2205-4ff2-870b-07d163c93079
      resultVariableName: bonde_rede_syncronized
      useRichDisplay: false
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig: null
  - cellType: CODE
    cellId: 925509f5-2554-465a-b6d2-91c37f927142 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: problema de integração das MSRs no listener-solidarity"
    config:
      source: |-
        if(bonde_rede_syncronized['count'][0] != 0):
            errors.append("Existem problemas de integração das MSRs no listener-solidarity")
  - cellType: MARKDOWN
    cellId: c7a10e04-e5d8-44fd-b640-39ce709a72cf # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Voluntárias teste se tornaram disponíveis para match"
  - cellType: SQL
    cellId: f5716778-6cc1-4476-8990-df0d6cbc5643 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Voluntárias teste se tornaram disponíveis"
    config:
      source: |-
        SELECT 
            COUNT(*)
        FROM volunteers
        INNER JOIN volunteer_availability ON id = volunteer_id
        WHERE 
            email IN ('dev.psi.mapa@gmail.com', 'dev.adv.mapa@gmail.com')
            AND is_available = TRUE
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: voluntarias_teste
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: condition
            renameTo: null
            size: 105
            wrapText: null
            displayFormat: null
          - originalName: count
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: email
            renameTo: null
            size: 170
            wrapText: null
            displayFormat: null
          - originalName: first_name
            renameTo: null
            size: 113
            wrapText: null
            displayFormat: null
          - originalName: id
            renameTo: null
            size: 68
            wrapText: null
            displayFormat: null
          - originalName: last_name
            renameTo: null
            size: 156
            wrapText: null
            displayFormat: null
          - originalName: phone
            renameTo: null
            size: 129
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 39
            wrapText: null
            displayFormat: null
          - originalName: volunteers.created_at
            renameTo: null
            size: 195
            wrapText: null
            displayFormat: null
          - originalName: volunteers.updated_at
            renameTo: null
            size: 242
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: 62661fdc-78ba-481f-a167-2fc80caf3773 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: Voluntárias teste se tornaram disponíveis"
    config:
      source: |-
        if(voluntarias_teste['count'][0] != 0):
            errors.append("Voluntárias teste se tornaram disponíveis para match")
  - cellType: MARKDOWN
    cellId: b1471b0d-82bd-4084-b641-014d94d9f185 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem voluntárias com current_matches >= max_matches e estão disponíveis"
  - cellType: SQL
    cellId: e7a581c6-1a76-4b9d-a833-67496b0d1086 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: voluntárias com current_matches >= max_matches e estão disponíveis"
    config:
      source: |-
        SELECT COUNT(*)
        FROM volunteer_availability
        LEFT JOIN volunteers ON id = volunteer_id
        WHERE 
            current_matches >= max_matches 
            AND is_available
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: voluntarias_current_matches
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: array_agg
            renameTo: null
            size: 843
            wrapText: null
            displayFormat: null
          - originalName: count
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: current_matches
            renameTo: null
            size: 147
            wrapText: null
            displayFormat: null
          - originalName: is_available
            renameTo: null
            size: 118
            wrapText: null
            displayFormat: null
          - originalName: lat
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: max_matches
            renameTo: null
            size: 131
            wrapText: null
            displayFormat: null
          - originalName: offers_online_support
            renameTo: null
            size: 173
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 24
            wrapText: null
            displayFormat: null
          - originalName: support_expertise
            renameTo: null
            size: 400
            wrapText: null
            displayFormat: null
          - originalName: support_type
            renameTo: null
            size: 127
            wrapText: null
            displayFormat: null
          - originalName: volunteer_id
            renameTo: null
            size: 122
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: 12159fe3-c1c2-4eae-98ef-acc75458131e # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: voluntárias com current_matches >= max_matches e estão disponíveis"
    config:
      source: |-
        if(voluntarias_current_matches['count'][0] != 0):
            errors.append("Existem voluntárias com current_matches >= max_matches e estão disponíveis")
  - cellType: MARKDOWN
    cellId: 357741dc-8374-485f-ab60-6cd1733692a5 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem MSRs que estão no Bonde mas não possuem support_request"
  - cellType: SQL
    cellId: 687a1e4f-2eee-4741-89fd-3b8c60b74dea # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: MSRs que estão no bonde mas não possuem support_request "
    config:
      source: |-
        WITH supports AS (
            SELECT 
                msr_id,
                support_type
            FROM match.support_requests
            WHERE status != 'duplicated'
            -- AND created_at >= '2024-04-18'
            ORDER BY msr_id, support_type
        ),
        msrs AS (
            SELECT 
                msr_id,
                ARRAY_TO_STRING(ARRAY_AGG(support_type::VARCHAR ORDER BY support_type::VARCHAR), '_') AS support_type
            FROM supports
            GROUP BY msr_id
        )
        SELECT 
            DISTINCT msr_id, support_type
        FROM msrs
        WHERE msr_id NOT IN (22858077211028, 23463276684564) -- casos de exceção
        -- GROUP BY 1
        -- HAVING COUNT(*) > 1
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: support_requests
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: support_type
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: count
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: msr_id
            renameTo: null
            size: 133
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 46
            wrapText: null
            displayFormat: null
          - originalName: string_agg
            renameTo: null
            size: 138
            wrapText: null
            displayFormat: null
          - originalName: support_type
            renameTo: null
            size: 387
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: SQL
    cellId: 450f3f6b-f523-4133-b6ae-580696fa0ec1 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: MSRs que estão no bonde mas não possuem support_request "
    config:
      source: |
        WITH filtered_solidarity_tickets AS (
            SELECT 
                t.requester_id, 
                t.status_acolhimento,
                CASE 
                    WHEN LOWER(REPLACE(SPLIT_PART(t.subject, ']', 1), '[', '')) = 'jurídico' THEN 'legal'
                    WHEN LOWER(REPLACE(SPLIT_PART(t.subject, ']', 1), '[', '')) = 'psicológico' THEN 'psychological'
                END AS tipo_de_acolhimento
            FROM solidarity_tickets t
            LEFT JOIN solidarity_users u ON requester_id = user_id
            WHERE 
            t.external_id IS NOT NULL
            AND t.status_acolhimento IS NOT NULL AND t.status_acolhimento NOT IN ('solicitação_repetida', 'X', '')
            AND t.created_at >= '2024-01-25'
            AND LOWER(REPLACE(SPLIT_PART(t.subject, ']', 1), '[', '')) IN ('jurídico', 'psicológico')
            AND u.condition != 'desabilitada'
            AND t.tags::VARCHAR NOT LIKE '%msr-fora-do-perfil%'
            AND t.requester_id != 21869249597716 -- daniel da busara
            ORDER BY LOWER(REPLACE(SPLIT_PART(t.subject, ']', 1), '[', ''))
        )
        SELECT 
            requester_id AS user_id,
            STRING_AGG(tipo_de_acolhimento, '_' ORDER BY tipo_de_acolhimento) AS tipo_de_acolhimento
        FROM filtered_solidarity_tickets
        GROUP BY requester_id
      dataFrameCell: false
      dataConnectionId: e088838c-2205-4ff2-870b-07d163c93079
      resultVariableName: solidarity_tickets_filtered
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: assignee_id
            renameTo: null
            size: 118
            wrapText: null
            displayFormat: null
          - originalName: created_at
            renameTo: null
            size: 196
            wrapText: null
            displayFormat: null
          - originalName: custom_fields
            renameTo: null
            size: 400
            wrapText: null
            displayFormat: null
          - originalName: description
            renameTo: null
            size: 162
            wrapText: null
            displayFormat: null
          - originalName: email
            renameTo: null
            size: 205
            wrapText: null
            displayFormat: null
          - originalName: group_id
            renameTo: null
            size: 118
            wrapText: null
            displayFormat: null
          - originalName: iana_time_zone
            renameTo: null
            size: 157
            wrapText: null
            displayFormat: null
          - originalName: id
            renameTo: null
            size: 68
            wrapText: null
            displayFormat: null
          - originalName: name
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: organization_id
            renameTo: null
            size: 138
            wrapText: null
            displayFormat: null
          - originalName: phone
            renameTo: null
            size: 89
            wrapText: null
            displayFormat: null
          - originalName: raw_subject
            renameTo: null
            size: 364
            wrapText: null
            displayFormat: null
          - originalName: requester_id
            renameTo: null
            size: 123
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 24
            wrapText: null
            displayFormat: null
          - originalName: shared_phone_number
            renameTo: null
            size: 181
            wrapText: null
            displayFormat: null
          - originalName: split_part
            renameTo: null
            size: 107
            wrapText: null
            displayFormat: null
          - originalName: status_acolhimento
            renameTo: null
            size: 202
            wrapText: null
            displayFormat: null
          - originalName: string_agg
            renameTo: null
            size: 138
            wrapText: null
            displayFormat: null
          - originalName: ticket_id
            renameTo: null
            size: 102
            wrapText: null
            displayFormat: null
          - originalName: time_zone
            renameTo: null
            size: 111
            wrapText: null
            displayFormat: null
          - originalName: tipo_de_acolhimento
            renameTo: null
            size: 167
            wrapText: null
            displayFormat: null
          - originalName: updated_at
            renameTo: null
            size: 196
            wrapText: null
            displayFormat: null
          - originalName: url
            renameTo: null
            size: 400
            wrapText: null
            displayFormat: null
          - originalName: user_id
            renameTo: null
            size: 118
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: SQL
    cellId: 4fcdef25-c2ee-4e50-8979-cd888bed3376 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: MSRs que estão no bonde mas não possuem support_request "
    config:
      source: |-
        SELECT COUNT(*) AS count
        FROM solidarity_tickets_filtered
        LEFT JOIN support_requests ON msr_id = user_id
        WHERE msr_id IS NULL OR tipo_de_acolhimento != support_type
        AND LENGTH(tipo_de_acolhimento) > LENGTH(support_type)
      dataFrameCell: true
      dataConnectionId: null
      resultVariableName: msrs_bonde_support_request
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: count
            renameTo: null
            size: 85
            wrapText: null
            displayFormat: null
          - originalName: count_star()
            renameTo: null
            size: 121
            wrapText: null
            displayFormat: null
          - originalName: msr_id
            renameTo: null
            size: 293
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 24
            wrapText: null
            displayFormat: null
          - originalName: support_type
            renameTo: null
            size: 127
            wrapText: null
            displayFormat: null
          - originalName: tipo_de_acolhimento
            renameTo: null
            size: 300
            wrapText: null
            displayFormat: null
          - originalName: user_id
            renameTo: null
            size: 226
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: 4a1e2c16-8506-486d-b0df-f72fd2e21966 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: MSRs que estão no bonde mas não possuem support_request "
    config:
      source: |-
        if(msrs_bonde_support_request['count'][0] != 0):
            errors.append("Existem MSRs que estão no Bonde mas não possuem support_request")
  - cellType: MARKDOWN
    cellId: 3f5f54da-b51c-4731-8f1c-b06156d5b684 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem MSRs desabilitadas com support_request"
  - cellType: SQL
    cellId: 4c5ebd1f-c12a-4b8a-b00e-355fe1a41c15 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "SQL: Msrs desabilitadas"
    config:
      source: |-
        SELECT user_id
        FROM public.solidarity_users
        WHERE condition = 'desabilitada'
      dataFrameCell: false
      dataConnectionId: e088838c-2205-4ff2-870b-07d163c93079
      resultVariableName: msrs_desabilitadas
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: created_at
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: email
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: iana_time_zone
            renameTo: null
            size: 168
            wrapText: null
            displayFormat: null
          - originalName: id
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: name
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: phone
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 46
            wrapText: null
            displayFormat: null
          - originalName: shared_phone_number
            renameTo: null
            size: 228
            wrapText: null
            displayFormat: null
          - originalName: time_zone
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: updated_at
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: url
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: user_id
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: SQL
    cellId: 731941c0-51cf-4273-9d38-c3bb245303ef # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Msr id support requests
    config:
      source: |-
        SELECT *
        FROM match.support_requests
        WHERE created_at >= '2024-06-19'
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: msr_id_support_requests
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: accepts_online_support
            renameTo: null
            size: 264
            wrapText: null
            displayFormat: null
          - originalName: city
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: has_disability
            renameTo: null
            size: 168
            wrapText: null
            displayFormat: null
          - originalName: lat
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: lng
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: msr_id
            renameTo: null
            size: 126
            wrapText: null
            displayFormat: null
          - originalName: priority
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: requires_libras
            renameTo: null
            size: 180
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 46
            wrapText: null
            displayFormat: null
          - originalName: support_expertise
            renameTo: null
            size: 204
            wrapText: null
            displayFormat: null
          - originalName: support_request_id
            renameTo: null
            size: 159
            wrapText: null
            displayFormat: null
          - originalName: support_type
            renameTo: null
            size: 144
            wrapText: null
            displayFormat: null
          - originalName: zendesk_ticket_id
            renameTo: null
            size: 204
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: SQL
    cellId: b01e79aa-1734-4992-9e3f-fdc513dadc80 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Msr "
    config:
      source: |-
        SELECT COUNT(*) AS count
        FROM msrs_desabilitadas
        INNER JOIN msr_id_support_requests ON msr_id = user_id
      dataFrameCell: true
      dataConnectionId: null
      resultVariableName: msrs_desabilitadas_com_support_request
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: count
            renameTo: null
            size: 82
            wrapText: null
            displayFormat: null
          - originalName: count_star()
            renameTo: null
            size: 144
            wrapText: null
            displayFormat: null
          - originalName: msr_id
            renameTo: null
            size: 133
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 24
            wrapText: null
            displayFormat: null
          - originalName: support_request_id
            renameTo: null
            size: 159
            wrapText: null
            displayFormat: null
          - originalName: user_id
            renameTo: null
            size: 133
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: 732051ce-1888-4ed5-bff9-4b9b3deb5cab # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: "Python: MSRs desabilitadas com support_request"
    config:
      source: |-
        if(msrs_desabilitadas_com_support_request['count'][0] != 0):
            errors.append("Existem MSRs desabilitadas com support_request")
  - cellType: MARKDOWN
    cellId: 7f17e65e-5279-4883-9272-69dd91db1fe2 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: "#### Existem inconsistências na migração de dados das MSRs"
  - cellType: SQL
    cellId: 25d05dfe-fec8-4872-a8a4-cee5830b971f # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Msrs bonde
    config:
      source: |-
        WITH users_with_rn AS (
            SELECT
                user_id AS msr_id,
                email,
                'not_found' AS gender,
                CASE 
                WHEN cor = 'amarela'  THEN 'yellow'
                WHEN cor = 'branca'  THEN 'white'
                WHEN cor = 'indigena'  THEN 'indigenous'
                WHEN cor = 'parda'  THEN 'brown'
                WHEN cor = 'preta'  THEN 'black'
                ELSE 'not_found'
                END AS race_color,
                NULL AS has_disability,
                TRUE AS accepts_online_support, 
                CASE WHEN cep IS NULL OR LENGTH(REGEXP_REPLACE(cep, '-', '', 'g')) != 8 THEN 'not_found' ELSE REGEXP_REPLACE(cep, '-', '', 'g') END AS zipcode,
                CASE 
                WHEN LENGTH(INITCAP(REGEXP_REPLACE(fields::TEXT, '\\u0000', '', 'g')::json->6->>'value'::TEXT)) > 100 THEN 'not_found'
                ELSE COALESCE(INITCAP(REGEXP_REPLACE(fields::TEXT, '\\u0000', '', 'g')::json->6->>'value'::TEXT), 'not_found')
            END AS neighborhood,
            
            BTRIM(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(city), 'À|Á|Â|Ã|Ä|Å', 'A', 'g'), 'È|É|Ê|Ë', 'E', 'g'), 'Í|Ì|Î|Ĩ|Ï ', 'I', 'g'), 'Ò|Ó|Ô|Õ|Ö', 'O', 'g'),'Ù|Ú|Û|Ü', 'U', 'g'), 'Ç', 'C', 'g')) AS city,
                BTRIM(UPPER(state)) AS state,
                CASE
                    WHEN condition = 'inscrita' THEN 'registered'
                    ELSE 'unregistered'
                END AS status,
                COALESCE(u.created_at, NOW()) AS created_at,
                COALESCE(u.updated_at, NOW()) AS updated_at,
                ROW_NUMBER() OVER(PARTITION BY email ORDER BY u.updated_at DESC) AS rn
            FROM solidarity_users u
            LEFT JOIN form_entries f ON u.external_id = f.id
            WHERE 
            organization_id = 360273031591
            AND email IS NOT NULL
            AND email != ''
        )
        SELECT COUNT(*)
        FROM users_with_rn
        WHERE rn = 1
      dataFrameCell: false
      dataConnectionId: e088838c-2205-4ff2-870b-07d163c93079
      resultVariableName: msrs_bonde
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: accepts_online_support
            renameTo: null
            size: 264
            wrapText: null
            displayFormat: null
          - originalName: city
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: count
            renameTo: null
            size: 82
            wrapText: null
            displayFormat: null
          - originalName: created_at
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: email
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: gender
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: has_disability
            renameTo: null
            size: 168
            wrapText: null
            displayFormat: null
          - originalName: msr_id
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: neighborhood
            renameTo: null
            size: 144
            wrapText: null
            displayFormat: null
          - originalName: race_color
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 46
            wrapText: null
            displayFormat: null
          - originalName: state
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: status
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: updated_at
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
          - originalName: zipcode
            renameTo: null
            size: 120
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: SQL
    cellId: 89f7b79a-89a2-41df-9470-0908e2e29639 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Msr msrs
    config:
      source: |-
        SELECT COUNT(*)
        FROM msr.msrs
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: msr_msrs
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: count
            renameTo: null
            size: 82
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 39
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: SQL
    cellId: 103fae51-d2a9-4521-82d2-74f93c1f88d4 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: Msr pii
    config:
      source: |-
        SELECT COUNT(*)
        FROM pii_sec.msr_pii
      dataFrameCell: false
      dataConnectionId: 683fd824-f935-4980-b99d-a7a513df5030
      resultVariableName: msr_pii
      useRichDisplay: true
      sqlCellOutputType: PANDAS
      useQueryMode: false
      castDecimals: true
      useNativeDates: true
      outputFilteredResult: true
      allowDuplicateColumns: false
      tableDisplayConfig:
        pageSize: 50
        height: null
        hideIcons: false
        hideIndex: false
        defaultSortColumn: null
        defaultSortIndexColumn: null
        defaultSortDirection: ASC
        conditionalFormatting: null
        calcs: null
        filters: null
        columnProperties:
          - originalName: count
            renameTo: null
            size: 82
            wrapText: null
            displayFormat: null
          - originalName: row-index-0
            renameTo: null
            size: 39
            wrapText: null
            displayFormat: null
        columnOrdering: null
        customColumnOrdering: null
        pinnedColumns: null
        hiddenColumns: null
        pinIndexColumns: false
        showAggregations: false
        columnAggregations: null
  - cellType: CODE
    cellId: 3c98b06b-e4aa-4a87-8d65-7eab4635e741 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: null
    config:
      source: |-
        if(msrs_bonde['count'][0] != msr_msrs['count'][0] or msrs_bonde['count'][0] != msr_pii['count'][0] or msr_msrs['count'][0] != msr_pii['count'][0]):
            errors.append("Existem inconsistências na migração de dados das MSRs")
  - cellType: CODE
    cellId: dfc0adcb-948b-44d4-a357-317f9fc425e5 # DO NOT CHANGE - Hex uses this to match up cells when reimporting the file, and detect any changes to existing cells
    cellLabel: raise errors
    config:
      source: |-
        if(len(errors) > 0):
            exception = "Alertas de dados: \n"
            for item in errors:
                exception += str(errors.index(item) + 1) + ". " + item + "\n"
            raise Exception(exception)
appLayout:
  visibleMetadataFields:
    - NAME
    - DESCRIPTION
    - AUTHOR
    - LAST_EDITED
    - LAST_RUN
    - CATEGORIES
    - STATUS
    - TABLE_OF_CONTENTS
  fullWidth: false
  tabs:
    - name: Tab 1
      rows:
        - columns:
            - start: 0
              end: 120
              elements:
                - showSource: true
                  hideOutput: false
                  type: CELL
                  cellId: dfc0adcb-948b-44d4-a357-317f9fc425e5
                  sharedFilterId: null
                  height: null
                  showLabel: true
sharedFilters: []
